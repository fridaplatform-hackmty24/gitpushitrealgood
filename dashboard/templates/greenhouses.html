{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <title>Greenhouses - GreenGuard</title>

    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description" content="Greenhouses - GreenGuard">
    <meta name="author" content="GreenGuard">
    <link rel="shortcut icon" href="{% static 'favicon.ico' %}">

    <!-- FontAwesome JS-->
    <script defer src="{% static 'assets/plugins/fontawesome/js/all.min.js' %}"></script>

    <!-- App CSS -->
    <link id="theme-style" rel="stylesheet" href="{% static 'assets/css/portal.css' %}">

</head>

<body class="app cool-background">
    <header class="app-header fixed-top">
        <div class="app-header-inner">
            <div class="container-fluid py-2">
                <div class="app-header-content">
                    <div class="row justify-content-between align-items-center">

                        <div class="col-auto">
                            <a id="sidepanel-toggler" class="sidepanel-toggler d-inline-block d-xl-none" href="#">
                                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30"
                                    role="img">
                                    <title>Menu</title>
                                    <path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10"
                                        stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path>
                                </svg>
                            </a>
                        </div><!--//col-->

                        <div class="app-utilities col-auto">
                            <div class="app-utility-item app-user-dropdown dropdown">
                                <a class="dropdown-toggle" id="user-dropdown-toggle" data-bs-toggle="dropdown" href="#"
                                    role="button" aria-expanded="false"><img src="{% static 'assets/images/user.png' %}"
                                        alt="user profile"></a>
                                <ul class="dropdown-menu" aria-labelledby="user-dropdown-toggle">
                                    <li><a class="dropdown-item" href="">Ajustes</a></li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li><a class="dropdown-item" href="{% url 'logout' %}">Cerrar Sesi√≥n</a></li>
                                </ul>
                            </div><!--//app-user-dropdown-->
                        </div><!--//app-utilities-->
                    </div><!--//row-->
                </div><!--//app-header-content-->
            </div><!--//container-fluid-->
        </div><!--//app-header-inner-->
        <div id="app-sidepanel" class="app-sidepanel">
            <div id="sidepanel-drop" class="sidepanel-drop"></div>
            <div class="sidepanel-inner d-flex flex-column">
                <a href="#" id="sidepanel-close" class="sidepanel-close d-xl-none">&times;</a>
                <div class="app-branding">
                    <a class="app-logo" href="{% url 'home' %}"><img class="logo-icon me-2"
                            src="{% static 'assets/images/app-logo.svg' %}" alt="logo"><span
                            class="logo-text">GREENGUARD</span></a>

                </div><!--//app-branding-->

                <nav id="app-nav-main" class="app-nav app-nav-main flex-grow-1">
                    <ul class="app-menu list-unstyled accordion" id="menu-accordion">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'dashboard' %}">
                                <span class="nav-icon">
                                    <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-house-door"
                                        fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd"
                                            d="M7.646 1.146a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 .146.354v7a.5.5 0 0 1-.5.5H9.5a.5.5 0 0 1-.5-.5v-4H7v4a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5v-7a.5.5 0 0 1 .146-.354l6-6zM2.5 7.707V14H6v-4a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4h3.5V7.707L8 2.207l-5.5 5.5z" />
                                        <path fill-rule="evenodd"
                                            d="M13 2.5V6l-2-2V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5z" />
                                    </svg>
                                </span>
                                <span class="nav-link-text">Tablero</span>
                            </a><!--//nav-link-->
                        </li><!--//nav-item-->
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'monitoring' %}">
                                <span class="nav-icon">
                                    <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-card-list"
                                        fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd"
                                            d="M14.5 3h-13a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h13a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z" />
                                        <path fill-rule="evenodd"
                                            d="M5 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 5 8zm0-2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0 5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5z" />
                                        <circle cx="3.5" cy="5.5" r=".5" />
                                        <circle cx="3.5" cy="8" r=".5" />
                                        <circle cx="3.5" cy="10.5" r=".5" />
                                    </svg>
                                </span>
                                <span class="nav-link-text">Monitoreo</span>
                            </a><!--//nav-link-->
                        </li><!--//nav-item-->
                        <li class="nav-item">
                            <a class="nav-link active" href="{% url 'greenhouses' %}">
                                <span class="nav-icon">
                                    <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-bar-chart-line"
                                        fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd"
                                            d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1V2zm1 12h2V2h-2v12zm-3 0V7H7v7h2zm-5 0v-3H2v3h2z" />
                                    </svg>
                                </span>
                                <span class="nav-link-text">Invernaderos</span>
                            </a><!--//nav-link-->
                        </li><!--//nav-item-->
                        <li class="nav-item"></li>
							<!--//Bootstrap Icons: https://icons.getbootstrap.com/ -->
							<a class="nav-link" href="{% url 'orders' %}">
								<span class="nav-icon">
									<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-columns-gap" fill="currentColor"
										xmlns="http://www.w3.org/2000/svg">
										<path fill-rule="evenodd"
											d="M6 1H1v3h5V1zM1 0a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1V1a1 1 0 0 0-1-1H1zm14 12h-5v3h5v-3zm-5-1a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1h-5zM6 8H1v7h5V8zM1 7a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1H1zm14-6h-5v7h5V1zm-5-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h5a1 1 0 0 0 1-1V1a1 1 0 0 0-1-1h-5z" />
									</svg>
								</span>
								<span class="nav-link-text">GreenShare</span>
							</a><!--//nav-link-->
						</li><!--//nav-item-->
                    </ul><!--//app-menu-->
                </nav><!--//app-nav-->
            </div><!--//sidepanel-inner-->
        </div><!--//app-sidepanel-->
    </header><!--//app-header-->

    <div class="app-wrapper">

        <div class="app-content pt-3 p-md-3 p-lg-4">
            <div class="container-xl">

                <h1 class="app-page-title">Greenhouse Manager</h1>
                <div class="app-card shadow-sm mb-4 border-left-decoration">
                    <div class="inner">
                        <div class="app-card-body p-4">
                            <div id="drawing-area"
                                style="width: 100%; height: 400px; border: 1px solid #ccc; position: relative;"></div>
                            <div class="mt-3">
                                <button id="undo-btn" class="btn app-btn-secondary" disabled>Undo Last
                                    Rectangle</button>
                                <select class="btn app-btn-primary" id="select-type">
                                    <option value="tomato">Tomato</option>
                                    <option value="cucumber">Cucumber</option>
                                    <option value="rice">Rice</option>
                                </select>
                            </div>
                            <form id="area-form" class="mt-3" method="post">
                                <div id="coordinates-container"></div>
                                <button type="submit" class="btn app-btn-primary mt-3">Submit</button>
                            </form>
                        </div><!--//app-card-body-->



                    </div><!--//inner-->

                </div><!--//app-card-->


                <div class="row g-4">
                    <div class="col-12 col-md-6">
                        <div class="app-card app-card-stat shadow-sm h-100">
                            <div class="app-card-body p-3">
                                <h4 class="stats-type mb-1">Total Greenhouses</h4>
                                <div class="stats-figure">{{ total_greenhouses }}</div>
                                <div class="stats-meta text-success">
                                    <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-arrow-up"
                                        fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd"
                                            d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z" />
                                    </svg> 20%
                                </div>
                            </div>
                            <a class="app-card-link-mask" href="#"></a>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="app-card app-card-stat shadow-sm h-100">
                            <div class="app-card-body p-3">
                                <h4 class="stats-type mb-1">Total Units¬≤</h4>
                                <div class="stats-figure">{{ total_square_units }}</div>
                                <div class="stats-meta">New</div>
                            </div>
                            <a class="app-card-link-mask" href="#"></a>
                        </div>
                    </div>
                </div>

                <!-- New History Section -->
                <div id="existing-greenhouses" class="mt-4">
                    <h3>Your Greenhouses</h3>
                    <div id="greenhouses-container" class="row"></div>
                </div>

                <!-- New Redraw Section -->
                <div id="redraw-section" class="mt-4" style="display: none;">
                    <h3>Redraw of Submitted Areas</h3>
                    <div id="redraw-area"
                        style="width: 100%; height: 400px; border: 1px solid #ccc; position: relative;">
                    </div>
                </div>
            </div><!--//app-content-->

            <footer class="app-footer">
                <div class="container text-center py-3">
                    <small class="copyright">Crafted with passion for growers by <a class="app-link"
                            href="{% url 'home' %}" target="_blank">GreenGuard</a><span class="sr-only"></span> <i
                            class="fas fa-leaf" style="color: #327230;"></i></small>

                </div>
            </footer><!--//app-footer-->

        </div><!--//app-wrapper-->


        <!-- Javascript -->
        <script src="{% static 'assets/plugins/popper.min.js' %}"></script>
        <script src="{% static 'assets/plugins/bootstrap/js/bootstrap.min.js' %}"></script>

        <!-- Page Specific JS -->
        <script src="{% static 'assets/js/app.js' %}"></script>

        <!-- Custom JS for drawing functionality -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const drawingArea = document.getElementById('drawing-area');
                const undoBtn = document.getElementById('undo-btn');
                const selectionInfoContainer = document.getElementById('coordinates-container');
                const areaForm = document.getElementById('area-form');
                const totalGreenhousesElement = document.querySelector('.stats-figure');
                const totalSquareUnitsElement = document.querySelectorAll('.stats-figure')[1];

                let gridSize = 16;
                let cellSize = 32;
                let totalSize = gridSize * cellSize;

                let selections = [];
                let isDrawing = false;
                let startCell, endCell;

                // Set up the drawing area
                drawingArea.style.border = '2px solid #15a362';
                drawingArea.style.position = 'relative';

                // Create the grid
                const canvas = document.createElement('canvas');
                drawingArea.appendChild(canvas);
                const ctx = canvas.getContext('2d');

                // Event listeners
                drawingArea.addEventListener('mousedown', startDrawing);
                drawingArea.addEventListener('mousemove', draw);
                drawingArea.addEventListener('mouseup', endDrawing);
                undoBtn.addEventListener('click', undoLastSelection);
                areaForm.addEventListener('submit', handleSubmit);

                initializeGrid();
                handleResize();

                function initializeGrid() {
                    canvas.width = totalSize;
                    canvas.height = totalSize;
                    drawingArea.style.width = totalSize + 'px';
                    drawingArea.style.height = totalSize + 'px';
                    drawGrid();
                }

                function drawGrid() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.strokeStyle = 'rgba(200, 200, 200, 0.5)';
                    ctx.lineWidth = 1;

                    for (let i = 0; i <= gridSize; i++) {
                        const pos = i * cellSize;
                        ctx.beginPath();
                        ctx.moveTo(pos, 0);
                        ctx.lineTo(pos, totalSize);
                        ctx.stroke();

                        ctx.beginPath();
                        ctx.moveTo(0, pos);
                        ctx.lineTo(totalSize, pos);
                        ctx.stroke();
                    }
                }

                function startDrawing(e) {
                    isDrawing = true;
                    const rect = canvas.getBoundingClientRect();
                    startCell = getCellCoords(e.clientX - rect.left, e.clientY - rect.top);
                    endCell = startCell;
                }

                function draw(e) {
                    if (!isDrawing) return;
                    const rect = canvas.getBoundingClientRect();
                    endCell = getCellCoords(e.clientX - rect.left, e.clientY - rect.top);
                    drawSelections();
                }

                function endDrawing() {
                    if (!isDrawing) return;
                    isDrawing = false;
                    if (startCell.x !== endCell.x || startCell.y !== endCell.y) {
                        selections.push({ start: startCell, end: endCell });
                        undoBtn.disabled = false;
                    }
                    drawSelections();
                }

                function getCellCoords(x, y) {
                    return {
                        x: Math.floor(x / cellSize),
                        y: Math.floor(y / cellSize)
                    };
                }

                function drawSelections() {
                    drawGrid();
                    ctx.fillStyle = 'rgba(40, 167, 69, 0.2)';
                    ctx.strokeStyle = '#28a745';
                    ctx.lineWidth = 2;

                    selections.forEach(selection => {
                        drawSelectionRect(selection.start, selection.end);
                    });

                    if (isDrawing) {
                        drawSelectionRect(startCell, endCell);
                    }
                }

                function drawSelectionRect(start, end) {
                    const left = Math.min(start.x, end.x) * cellSize;
                    const top = Math.min(start.y, end.y) * cellSize;
                    const width = (Math.abs(end.x - start.x) + 1) * cellSize;
                    const height = (Math.abs(end.y - start.y) + 1) * cellSize;

                    ctx.fillRect(left, top, width, height);
                    ctx.strokeRect(left, top, width, height);
                }

                function undoLastSelection() {
                    if (selections.length > 0) {
                        selections.pop();
                        drawSelections();
                        undoBtn.disabled = selections.length === 0;
                    }
                }

                function updateSelectionInfo() {
                    selectionInfoContainer.innerHTML = '';
                    let totalSquares = 0;
                    selections.forEach((selection, index) => {
                        const width = Math.abs(selection.end.x - selection.start.x) + 1;
                        const height = Math.abs(selection.end.y - selection.start.y) + 1;
                        const squares = width * height;
                        totalSquares += squares;
                        const selectionDiv = document.createElement('div');
                        selectionDiv.innerHTML = `<b>[Area ${index + 1}] - ${squares}u¬≤</b>`;
                        selectionInfoContainer.appendChild(selectionDiv);
                    });
                    if (selections.length > 0) {
                        const totalDiv = document.createElement('div');
                        totalDiv.innerHTML = `<h5>Total Squares: ${totalSquares}</h5>`;
                        selectionInfoContainer.appendChild(totalDiv);
                    }
                }

                function finishSelection() {

                    undoBtn.disabled = true;
                    drawingArea.style.pointerEvents = 'none';
                    updateSelectionInfo();
                }

                function cancelSelection() {
                    undoBtn.disabled = selections.length === 0;
                    drawingArea.style.pointerEvents = 'auto';
                    selectionInfoContainer.innerHTML = '';
                }

                function handleResize() {
                    const containerWidth = drawingArea.parentElement.offsetWidth;
                    const minSize = Math.min(containerWidth - 40, 480); // 40px for padding, max 480px

                    if (minSize < totalSize) {
                        gridSize = 16;
                        cellSize = Math.floor(minSize / gridSize);
                        totalSize = gridSize * cellSize;
                        initializeGrid();
                    }

                    drawSelections();
                }

                function handleSubmit(e) {
                    e.preventDefault();
                    if (selections.length === 0) {
                        showNotification('Please draw at least one area.', false);
                        return;
                    }

                    var formData = new FormData();
                    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                    formData.append('selections', JSON.stringify(selections));
                    formData.append('type', document.getElementById('select-type').value);
                    fetch('', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Success:', data);
                            // Handle successful submission here
                            selections = [];
                            drawSelections();
                            updateSelectionInfo();
                            cancelSelection();
                            // Reload the page to update greenhouse stats and list
                            window.location.reload();
                        })
                        .catch((error) => {
                            console.error('Error:', error);
                            // Handle errors
                        });
                }

                // Load existing greenhouses
                const greenhousesData = JSON.parse('{{ greenhouses|safe }}');
                const greenhousesContainer = document.getElementById('greenhouses-container');

                function loadExistingGreenhouses() {
                    greenhousesContainer.innerHTML = '';  // Clear existing content

                    greenhousesData.forEach(greenhouse => {
                        const greenhouseDiv = document.createElement('div');
                        greenhouseDiv.className = 'col-md-4 mb-4';
                        greenhouseDiv.innerHTML = `
            <div class="app-card app-card-basic d-flex flex-column align-items-start shadow-sm">
                <div class="app-card-header p-3 border-bottom-0">
                    <div class="row align-items-center gx-3">
                        <div class="col-auto">
                            <div class="app-icon-holder">
                                <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-house" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M2 13.5V7h1v6.5a.5.5 0 0 0 .5.5h9a.5.5 0 0 0 .5-.5V7h1v6.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5zm11-11V6l-2-2V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5z"/>
                                    <path fill-rule="evenodd" d="M7.293 1.5a1 1 0 0 1 1.414 0l6.647 6.646a.5.5 0 0 1-.708.708L8 2.207 1.354 8.854a.5.5 0 1 1-.708-.708L7.293 1.5z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="col-auto">
                            <h4 class="app-card-title">${greenhouse.name}</h4>
                        </div>
                    </div>
                </div>
                <div class="app-card-body px-4 w-100">
                    <div class="app-card-body-inner">
                        <canvas id="greenhouse-preview-${greenhouse.id}" width="200" height="200"></canvas>
                    </div>
                </div>
                <div class="app-card-footer p-4 mt-auto">
                    <button class="btn app-btn-secondary view-details" data-id="${greenhouse.id}">View Details</button>
                    <button class="btn app-btn-secondary edit-name" data-id="${greenhouse.id}">Edit Name</button>
                    <button class="btn app-btn-secondary delete-greenhouse" data-id="${greenhouse.id}">Delete</button>
                </div>
            </div>
        `;
                        greenhousesContainer.appendChild(greenhouseDiv);

                        const canvas = document.getElementById(`greenhouse-preview-${greenhouse.id}`);
                        const ctx = canvas.getContext('2d');
                        drawGreenhousePreview(ctx, greenhouse.data);
                    });

                    // Add event listeners for the new buttons
                    document.querySelectorAll('.view-details').forEach(button => {
                        button.addEventListener('click', viewDetails);
                    });

                    document.querySelectorAll('.edit-name').forEach(button => {
                        button.addEventListener('click', editName);
                    });

                    document.querySelectorAll('.delete-greenhouse').forEach(button => {
                        button.addEventListener('click', deleteGreenhouse);
                    });
                }

                function drawGreenhousePreview(ctx, data) {
                    const previewGridSize = 16;
                    const previewCellSize = 200 / previewGridSize;

                    // Draw grid
                    ctx.strokeStyle = 'rgba(200, 200, 200, 0.5)';
                    ctx.lineWidth = 1;
                    for (let i = 0; i <= previewGridSize; i++) {
                        const pos = i * previewCellSize;
                        ctx.beginPath();
                        ctx.moveTo(pos, 0);
                        ctx.lineTo(pos, 200);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(0, pos);
                        ctx.lineTo(200, pos);
                        ctx.stroke();
                    }

                    // Draw selections
                    ctx.strokeStyle = '#28a745';
                    ctx.lineWidth = 2;
                    data.forEach((selection, index) => {
                        const left = Math.min(selection.start.x, selection.end.x) * previewCellSize;
                        const top = Math.min(selection.start.y, selection.end.y) * previewCellSize;
                        const width = (Math.abs(selection.end.x - selection.start.x) + 1) * previewCellSize;
                        const height = (Math.abs(selection.end.y - selection.start.y) + 1) * previewCellSize;

                        // Set fillStyle for each area
                        ctx.fillStyle = 'rgba(40, 167, 69, 0.2)';
                        ctx.fillRect(left, top, width, height);
                        ctx.strokeRect(left, top, width, height);

                        // Add area name
                        ctx.fillStyle = '#28a745';
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(`Area ${index + 1}`, left + width / 2, top + height / 2);
                    });
                }

                function viewDetails(event) {
                    const greenhouseId = event.target.getAttribute('data-id');
                    // Implement view details functionality
                    console.log('View details for greenhouse:', greenhouseId);
                }

                function showNotification(message, isSuccess = true) {
                    const notification = document.createElement('div');
                    notification.textContent = message;
                    notification.style.position = 'fixed';
                    notification.style.bottom = '20px';  // Changed from top to bottom
                    notification.style.right = '20px';
                    notification.style.padding = '10px 20px';
                    notification.style.borderRadius = '5px';
                    notification.style.color = 'white';
                    notification.style.backgroundColor = isSuccess ? '#28a745' : '#dc3545';
                    notification.style.zIndex = '1000';
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }

                function editName(event) {
                    const greenhouseId = event.target.getAttribute('data-id');
                    const newName = prompt('Enter new name for the greenhouse:');
                    if (newName) {
                        if (confirm(`Are you sure you want to rename this greenhouse to "${newName}"?`)) {
                            fetch(`/api/${greenhouseId}/edit/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                credentials: 'same-origin',
                                body: `new_name=${encodeURIComponent(newName)}`
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        event.target.closest('.app-card').querySelector('.app-card-title').textContent = data.new_name;
                                        showNotification('Greenhouse name updated successfully!');
                                    } else {
                                        showNotification('Failed to update greenhouse name: ' + data.error, false);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    showNotification('An error occurred while updating the greenhouse name.', false);
                                });
                        }
                    }
                }

                function deleteGreenhouse(event) {
                    const greenhouseId = event.target.getAttribute('data-id');
                    if (confirm('Are you sure you want to delete this greenhouse?')) {
                        fetch(`/api/${greenhouseId}/delete/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            credentials: 'same-origin'
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    event.target.closest('.col-md-4').remove();
                                    showNotification('Greenhouse deleted successfully!');
                                    updateGreenhouseStats();
                                } else {
                                    showNotification('Failed to delete greenhouse.', false);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                showNotification('An error occurred while deleting the greenhouse.', false);
                            });
                    }
                }

                function updateGreenhouseStats() {
                    const totalGreenhousesElement = document.querySelector('.stats-figure');
                    const totalSquareUnitsElement = document.querySelectorAll('.stats-figure')[1];
                    const greenhouseCount = document.querySelectorAll('.col-md-4').length;

                    totalGreenhousesElement.textContent = greenhouseCount;

                    // Recalculate total square units
                    let totalSquareUnits = 0;
                    greenhousesData.forEach(greenhouse => {
                        greenhouse.data.forEach(selection => {
                            const width = Math.abs(selection.end.x - selection.start.x) + 1;
                            const height = Math.abs(selection.end.y - selection.start.y) + 1;
                            totalSquareUnits += width * height;
                        });
                    });
                    totalSquareUnitsElement.textContent = totalSquareUnits;
                }

                // Add event listeners for the new buttons
                document.querySelectorAll('.view-details').forEach(button => {
                    button.addEventListener('click', viewDetails);
                });

                document.querySelectorAll('.edit-name').forEach(button => {
                    button.addEventListener('click', editName);
                });

                document.querySelectorAll('.delete-greenhouse').forEach(button => {
                    button.addEventListener('click', deleteGreenhouse);
                });




                loadExistingGreenhouses();
            });
        </script>

</body>

</html>